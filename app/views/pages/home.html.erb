<% unless user_signed_in? %>
  <div class="jumbotron center">
    <div class="form-group">
      <%= link_to image_tag("asclogo.png" ), root_path %>
    </div>
    <h1>Staff Resources</h1>
      <%= link_to "Log in", new_user_session_path, class: "btn btn-primary btn-lg" %>
      <%= link_to "Sign up", new_user_registration_path, class: "btn btn-default btn-lg" %>
  </div>
<% else %>
<h1>ASC Staff Resources</h1>
  <%require 'open-uri' #Wrapper to open web-based data with open() function %>
  <%require 'nokogiri' #Library to parse the XML file we'll open%>

  <% file = open('http://signs.adventuresci.org/data/todaysold.xml').read%>
  <% file.gsub! '<d:', '<'%>
  <% file.gsub! '<m:', '<'%>
  <% xml = Nokogiri::XML(file)%>
  <% runningtotal = 0 %>
  <% xml.css('entry').each do |node|%>
    <% sold = node.at('TicketQuantity').text.to_i%>
    <% refunded = node.at('TicketNumberRefunded').text.to_i%>
    <% sold -= refunded %>
    <% runningtotal += sold %>
  <%end%>

  <% ga = open('http://signs.adventuresci.org/data/gatoday.xml').read%>
  <% ga.gsub! '<d:', '<'%>
  <% ga.gsub! '<m:', '<'%>
  <% gaxml = Nokogiri::XML(ga)%>
  <% garunningtotal = 0 %>
  <% gaxml.css('entry').each do |node|%>
    <% sold = node.at('COUNTSalesOrderItemSalesOrderItemTicketTicketsActive').text.to_i%>
    <% garunningtotal += sold %>
  <%end%>

  <%group = open('http://signs.adventuresci.org/data/totalsforfacilities.xml').read%>
  <%group.gsub! '<d:', '<'%>
  <%group.gsub! '<m:', '<'%>
  <%group = Nokogiri::XML(group)%>

  <% sciencelive = open('https://spreadsheets.google.com/feeds/list/1sHG-MldUpOushzh5VpYiycrCl1UhPjfLlzrV-IfJYj0/od6/public/values').read%>
  <% sciencelive.gsub! '<gsx:', '<'%>
  <% sciencelive = Nokogiri::XML(sciencelive)%>
 
  <div class="row">
    <div class="col-md-3 col-sm-6 col-xs-12">
      <h2>Today</h2>
      <p><span class="glyphicon glyphicon-user" aria-hidden="true"></span> <strong><%=garunningtotal%></strong> guest admissions</p>
      <%group.css('entry').each do |node|%>
        <% date = DateTime.strptime(node.at('Arrivaldate').text,"%Y-%m-%dT%H:%M:%S")%>
        <% if date.strftime("%A %-m/%-d") == DateTime.now.in_time_zone("Central Time (US & Canada)").strftime("%A %-m/%-d")%>
          <p><span class="glyphicon glyphicon-bell" aria-hidden="true"></span> <strong><%= node.at('SUMItinerariesAttendeesQuantity').text %></strong> group admissions</p>
        <%end%>
      <%end%>
      <p><span class="glyphicon glyphicon-film" aria-hidden="true"></span> <strong><%=runningtotal%></strong> planetarium tickets sold</p>

      <% if Stay.count > 0 %>
        <%= link_to new_stay_path, class: "btn btn-primary" do %>
          Staying late
          <span class="badge"><span class="glyphicon glyphicon-user"></span> <%= Stay.count %></span>
        <% end %>
      <% else %>
        <%= link_to new_stay_path, class: "btn btn-default" do %>
          Staying late
        <% end %>
      <% end %>

    </div>
    <div class="col-lg-5 col-md-4 col-sm-6 col-xs-12">
      <h2>Science Live</h2>
      <% sciencelive.css('entry').each do |node|%>
        <% if node.at('date').text == DateTime.now.in_time_zone("Central Time (US & Canada)").strftime("%A, %B %-d, %Y") %>
          <% line1 = node.at('sciencelivea').text %>
          <% line2 = node.at('scienceliveb').text %>
          <% staffer = node.at('educators').text %>
          <% info = node.at('additionalinfo').text %>
          <p><%= line1.sub(/\*(.*)\*/,'<strong>\1</strong>').html_safe%></p>
          <p><%= line2.sub(/\*(.*)\*/,'<strong>\1</strong>').html_safe%></p>
          <p><strong>Staff:</strong> <%= staffer.html_safe%></p>
          <p><strong>Additional Info:</strong> <%= info.html_safe%></p>
        <%end%>
      <%end%>
      <div class="btn-group" role="group" aria-label="Science Live Links">
        <%= link_to "View", "http://signs.adventuresci.org/sciencelive/", class: "btn btn-default", :target => "_blank"  %>
        <%= link_to "Edit", "https://docs.google.com/spreadsheets/d/1sHG-MldUpOushzh5VpYiycrCl1UhPjfLlzrV-IfJYj0/edit#gid=0", class: "btn btn-default", :target => "_blank"  %>
      </div>
    </div>
    <div class="clearfix visible-sm-block"></div>
    <div class="col-lg-2 col-md-3 col-sm-6 col-xs-12">
      <h2>Links</h2>
      <div class="list-group" role="group" aria-label="...">
        <%= link_to "Altru", "http://tiny.cc/altru", class: "list-group-item", :target => "_blank"  %>
        <%= link_to "Slack", "http://adventuresci.slack.com", class: "list-group-item", :target => "_blank"  %>
        <%= link_to "Office 365", "http://login.microsoftonline.com", class: "list-group-item", :target => "_blank"  %>
        <%= link_to "Website", "http://adventuresci.org", class: "list-group-item", :target => "_blank"  %>
        <%= link_to "Brand Guide", "https://app.frontify.com/d/Mo9hIEF1B6T2/adventure-science-center-style-guide", class: "list-group-item", :target => "_blank"  %>
      </div>
    </div>
    <div class="col-md-2 col-sm-6 col-xs-12">
      <h2>Timecard</h2>
      <div class="list-group" role="group" aria-label="...">
        <%= link_to "Employee", "https://adventuresci.attendanceondemand.com/ess/", class: "list-group-item", :target => "_blank"  %>
        <%= link_to "Supervisor", "https://adventuresci.attendanceondemand.com/operator/", class: "list-group-item", :target => "_blank"  %>
        <%= link_to "Payroll (Inova)", "https://inovapayroll.evolutionpayroll.com/ess#/login", class: "list-group-item", :target => "_blank"  %>
      </div>
    </div>
  </div>
<% end %>

